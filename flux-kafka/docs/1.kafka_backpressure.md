# Kafka backpressure (배압)

- 서버의 처리량과, Kafka 메시지 전송량에 따라 스펙을 넘어서는 처리량이 발생할 수 있음
  - 이럴 경우, Kafka는 메시지를 쌓아두고, 서버는 처리하지 못하는 상황이 발생함 
  - 심하면 서버가 다운되는 상황이 발생할 수 있음 .
- 이럴 경우 서버에서 `Backpressure(배압)` 를 적용하여, 서버가 처리할 수 있는 만큼만 Kafka 로부터 메시지를 받아 처리하도록 할 수 있다.

> 즉, 소비자(Consumer) 가 감당할 수 없는 양의 데이터를 받지 않도록 제어하는것. <br/>
> - 1초에 1000개의 메시지가 오는 상황이고
> - 메시지 처리속도가 1초에 100개 라면, 메모리 폭주 가능성 존재함.


---
## Backpressure 적용 방법

- Backpressure 적용은 sender, receiver 에서 모두 적용할 수 있다.
  - Sender 에서 적용할 경우, 메시지를 보내는 속도를 조절하여 서버의 부하를 줄일 수 있다.
  - Receiver 에서 적용할 경우, 서버가 처리할 수 있는 만큼만 메시지를 받아 처리하도록 할 수 있으며
    - WebFlux 의 경우, 병렬로 최대 몇개까지 동시에 처리할지 설정 할 수 있다.

<br/><br/>


### Sender 에서 Backpressure 적용
- sender 에서 Backpressure 를 적용하는 방법은 2가지가 있다.
  - 서버에서 `Duration` 만큼 대기 후 메시지를 전송하는 방법
  - `senderOptions` 에서 `maxInFlight` 를 설정하여, 동시에 전송할 수 있는 메시지의 개수를 제한하는 방법
```kotlin
val senderOptions = SenderOptions.create<String, String>(props)
    .maxInFlight(100) // 동시에 처리할 최대 레코드 수 제한 default: 256(webflux)

val records = Flux.range(1, 1000)
    .delayElements(Duration.ofMillis(10)) // 메시지 발행 속도 조절
    .map { i ->
        SenderRecord.create(/* ProducerRecord 생성 코드 */, null)
    }
```

<br/><br/>

### Receiver 에서 Backpressure 적용
- receiver 에서 Backpressure 를 적용하는 방법은 크게 2가지가 존재한다. 다만 옵션에 따라 기능이 완전 다르게 동작할 수 있음.

1. `receiver.receive().limitRate(n: Int)` 사용 
   - 내부적으로 Kafka 로 부터 최대 n 개의 메시지를 가져오도록(요청) 설정 하는것.
   - `flatmap(..., concurrency = n)` 과 함께 사용하여, 동시에 처리할 최대 개수를 제한할 수 있다.
     - concurrency = n 을 사용하지 않으면, 동시 처리 무제한.
   - 서버의 리소스와, 처리해야할 메시지양, 처리속도에 따라 값을 변경! 
     - 실제 트래픽과 처리량을 테스트 하여 최적값을 찾는것 중요
     - 너무 크면 과부하(CPU/Mem), 너무 적으면 (throughput 처리량) 낮아짐
   - 순차처리 필요시 `flatMapSequential` 사용
2. `receiver.receive().onBackpressureBuffer(n: Int)` 사용
   - 최대 n 개의 메시지를 버퍼에 쌓아두고, 처리할 수 있는 만큼만 처리하는 방식
   - `onBackpressureDrop` 사용한다면, 버퍼가 가득 찼을 때, 가장 오래된 메시지를 제거하고 새로운 메시지를 추가하는 방식 : 대게 위험

```kotlin
// 1. Receive with limitRate
receiver.receive()
    .limitRate(100) // 최대 100개 메시지 요청 default: 256

// 2. Receive with onBackpressureBuffer
receiver.receive()
    .onBackpressureBuffer(100) // 최대 100개 메시지 버퍼에 쌓고 처리

// 3. Receive with onBackpressureDrop
receiver.receive()
    .onBackpressureBuffer(1000, { dropped ->
        log.warn("Dropped record: $dropped")
    })
    .subscribe()
```






